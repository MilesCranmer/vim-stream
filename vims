#!/bin/bash
# The argument fixes were supplied by John Kugelman
# https://stackoverflow.com/a/44745698/2689923
vim_cmds=()

PRINT_ALL=1
DISABLE_VIMRC=0
EXE_MODE=0
INVERSE_EXE_MODE=0
SIMPLE_MODE=0

while (($# > 0)); do
    arg="$1"
    case "$arg" in
        -n|--silent|--quiet)
            PRINT_ALL=0
            shift
            ;;
        -d|--disable-vimrc)
            DISABLE_VIMRC=1
            shift
            ;;
        -e|--exe-mode)
            EXE_MODE=1
            shift
            ;;
        -r|--inverse-exe-mode)
            INVERSE_EXE_MODE=1
            shift
            ;;
        -s|--simple-mode)
            SIMPLE_MODE=1
            shift
            ;;
        -m|--no-mode)
            SIMPLE_MODE=0
            INVERSE_EXE_MODE=0
            EXE_MODE=0
            shift
            ;;
        *)
            if [ "$EXE_MODE" -eq "0"  ] && [ "$INVERSE_EXE_MODE" -eq "0" ] && [ "$SIMPLE_MODE" -eq "0" ]; then
                vim_cmds+=(-c "$1")
                shift
            elif [ "$EXE_MODE" -eq "1" ] && [ "$INVERSE_EXE_MODE" -eq "0" ] && [ "$SIMPLE_MODE" -eq "0" ]; then
                SEARCH="$1"
                CMD="$2"
                vim_cmds+=(-c "%g/${SEARCH}/exe \"norm ${CMD}\"")
                shift
                shift
            elif [ "$EXE_MODE" -eq "0" ] && [ "$INVERSE_EXE_MODE" -eq "1" ] && [ "$SIMPLE_MODE" -eq "0" ]; then
                SEARCH="$1"
                CMD="$2"
                vim_cmds+=(-c "%v/${SEARCH}/exe \"norm ${CMD}\"")
                shift
                shift
            elif [ "$EXE_MODE" -eq "0" ] && [ "$INVERSE_EXE_MODE" -eq "0" ] && [ "$SIMPLE_MODE" -eq "1" ]; then
                CMD="$1"
                vim_cmds+=(-c ":exe \"norm gg""${CMD}""\"")
                shift
            else
                echo "Mode conflict for vims! Please select only one mode."
                echo "Modes enabled: exe-mode? $EXE_MODE, inverse-exe-mode? $INVERSE_EXE_MODE, simple-mode? $SIMPLE_MODE"
                exit 1
            fi
            ;;
    esac
done

# Headless vim which exits after printing all lines
# Taken from Csaba Hoch:
# https://groups.google.com/forum/#!msg/vim_use/NfqbCdUkDb4/Ir0faiNaFZwJ
if [ "$PRINT_ALL" -eq "1" ]; then
    vim_cmds+=(-c ":%p")
fi
if [ "$DISABLE_VIMRC" -eq "1" ]; then
    vim_cmds=(-u NONE "${vim_cmds[@]}")
fi

vim - -nes "${vim_cmds[@]}" -c ':q!' | tail -n +2

