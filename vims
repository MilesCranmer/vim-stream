#!/bin/bash
# The argument fixes were supplied by John Kugelman
# https://stackoverflow.com/a/44745698/2689923
vim_cmds=()

PRINT_ALL=1
DISABLE_VIMRC=0
MODE=none

while (($# > 0)); do
    arg="$1"
    case "$arg" in
        -n|--silent|--quiet)
            PRINT_ALL=0
            shift
            ;;
        -d|--disable-vimrc)
            DISABLE_VIMRC=1
            shift
            ;;
        -e|--exe-mode)
            MODE=exe
            shift
            ;;
        -r|--inverse-exe-mode)
            MODE=inverse-exe
            shift
            ;;
        -l|--line-exe-mode)
            MODE=line-exe
            shift
            ;;
        -s|--simple-mode)
            MODE=simple
            shift
            ;;
        -t|--turn-off-mode)
            MODE=none
            shift
            ;;
        *)
            if [ "$MODE" = "none" ]; then
                vim_cmds+=(-c "$1")
                shift
            elif [ "$MODE" = "exe" ]; then
                SEARCH="$1"
                CMD="$2"
                vim_cmds+=(-c "%g/${SEARCH}/exe \"norm ${CMD}\"")
                shift
                shift
            elif [ "$MODE" = "inverse-exe" ]; then
                SEARCH="$1"
                CMD="$2"
                vim_cmds+=(-c "%v/${SEARCH}/exe \"norm ${CMD}\"")
                shift
                shift
            elif [ "$MODE" = "simple" ]; then
                CMD="$1"
                vim_cmds+=(-c ":exe \"norm gg""${CMD}""\"")
                shift
            elif [ "$MODE" = "line-exe" ]; then
                CMD="$1"
                vim_cmds+=(-c ":%g/.*/exe \"norm ""${CMD}""\"")
                shift
            else
                echo "Mode not known to vims! Please select a known mode."
                echo "Mode selected: $MODE"
                exit 1
            fi
            ;;
    esac
done

# Headless vim which exits after printing all lines
# Taken from Csaba Hoch:
# https://groups.google.com/forum/#!msg/vim_use/NfqbCdUkDb4/Ir0faiNaFZwJ
if [ "$PRINT_ALL" -eq "1" ]; then
    vim_cmds+=(-c ":%p")
fi
if [ "$DISABLE_VIMRC" -eq "1" ]; then
    vim_cmds=(-u NONE "${vim_cmds[@]}")
fi

vim - -nes "${vim_cmds[@]}" -c ':q!' | tail -n +2

